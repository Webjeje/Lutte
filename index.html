<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Compteur de Lutte ‚Äì WebJ√©J√©</title>
  <!-- Chart.js pour le graphe -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- QRious pour le QR code -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <!-- Ic√¥nes -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1220;            /* fond global */
      --bg-2:#0f172a;          /* gradient */
      --card:#0e1726cc;        /* verre sombre */
      --border:#1f2a44;        /* bordures subtiles */
      --text:#e5e7eb;          /* texte clair */
      --muted:#9ca3af;         /* texte secondaire */
      --blue:#3b82f6;          /* bleu */
      --red:#ef4444;           /* rouge */
      --green:#22c55e;         /* succ√®s */
      --yellow:#f59e0b;        /* accent */
      --ring:rgba(59,130,246,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:linear-gradient(180deg,var(--bg),var(--bg-2) 40%,var(--bg));
      color:var(--text);
      min-height:100vh;
    }
    header{
      position:sticky; top:0; z-index:10; backdrop-filter:saturate(180%) blur(8px);
      background:linear-gradient(180deg,#0b1220cc,#0b122000);
      border-bottom:1px solid var(--border);
    }
    .container{max-width:1100px; margin:0 auto; padding:12px 14px}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .title{font-weight:700; letter-spacing:.2px; margin-right:auto; display:flex; gap:10px; align-items:center}

    .btn{
      appearance:none; border:1px solid var(--border); background:linear-gradient(180deg,#0d1628,#0b1324);
      color:var(--text); padding:.55rem .7rem; border-radius:.8rem; cursor:pointer; font-weight:600; font-size:.95rem;
      box-shadow:0 0 0 0 rgba(0,0,0,0); transition:.15s ease; display:inline-flex; align-items:center; gap:.5rem
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 6px 14px -10px #000}
    .btn:active{transform:translateY(0)}
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .btn-outline{background:transparent}
    /* Ic√¥nes seules */
    .icon-btn{width:44px;height:44px;padding:0;display:grid;place-items:center;border-radius:12px}
    .icon-btn i{font-size:1.2rem}

    main{padding:16px 0}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; overflow:hidden}
    .card-h{display:flex; align-items:center; justify-content:space-between; padding:14px 14px 10px; border-bottom:1px solid var(--border)}
    .col-title{display:flex; align-items:baseline; gap:10px}
    .badge{display:inline-flex; gap:6px; align-items:center; padding:.18rem .5rem; border:1px solid var(--border); border-radius:999px; color:var(--muted); font-size:.8rem}
    .score{font-size:2.8rem; font-weight:900}
    .score small{font-size:.8rem; color:var(--muted); font-weight:600}

    .card-b{padding:12px; display:grid; gap:10px}
    .action{position:relative; display:flex}
    .action button{
      flex:1; border:1px solid var(--border); background:#0b1426; color:var(--text); padding:15px 14px; border-radius:12px;
      font-weight:700; letter-spacing:.2px; font-size:1rem; text-align:left; cursor:pointer; transition:.15s ease; min-height:56px
    }
    .action button:hover{transform:translateY(-1px)}
    .action button:active{transform:translateY(0)}
    .action button[disabled]{opacity:.45; cursor:not-allowed}
    .chip{position:absolute; right:10px; top:10px; font-size:.82rem; border:1px solid var(--border); color:var(--muted); padding:.1rem .45rem; border-radius:999px}
    .count{position:absolute; right:10px; bottom:10px; font-size:.82rem; color:var(--muted)}

    /* Accents BLEU/ROUGE plus marqu√©s */
    .blue .card-h{background:linear-gradient(180deg,rgba(59,130,246,.25),transparent)}
    .red  .card-h{background:linear-gradient(180deg,rgba(239,68,68,.25),transparent)}
    .blue .score{color:var(--blue)}
    .red .score{color:var(--red)}
    .card.blue{border:2px solid #2563eb; box-shadow:0 0 0 1px rgba(37,99,235,.2) inset}
    .card.red {border:2px solid #dc2626; box-shadow:0 0 0 1px rgba(220,38,38,.2) inset}
    .blue .action button{background:linear-gradient(180deg,rgba(59,130,246,.18),#0b1426); border-color:#1d4ed8}
    .red  .action button{background:linear-gradient(180deg,rgba(239,68,68,.18),#0b1426); border-color:#b91c1c}
    .blue .action button:hover{box-shadow:0 0 0 2px rgba(59,130,246,.32)}
    .red  .action button:hover{box-shadow:0 0 0 2px rgba(239,68,68,.32)}
    .blue .chip{border-color:#1d4ed8}
    .red  .chip{border-color:#b91c1c}

    /* Modals */
    .overlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:16px; z-index:30}
    .overlay.open{display:flex}
    .backdrop{position:absolute; inset:0; backdrop-filter:blur(8px); background:rgba(3,8,20,.55)}
    .modal{position:relative; max-width:960px; width:min(960px,96vw); background:linear-gradient(180deg,#0e1728,#0c1426);
      border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 20px 80px rgba(0,0,0,.45)}
    .modal h3{margin:0 0 10px 0}
    .modal .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:720px){.modal .grid2{grid-template-columns:1fr}}
    .modal .section{border:1px solid var(--border); border-radius:12px; padding:12px}
    .row{display:grid; grid-template-columns:1fr auto auto; align-items:center; gap:8px; padding:8px 0; border-bottom:1px dashed #1b2540}
    .row:last-child{border-bottom:0}
    .select,.input,.switch{background:#0a1325; border:1px solid var(--border); color:var(--text); padding:.45rem .6rem; border-radius:10px; font-weight:600}
    .switch{display:inline-flex; align-items:center; gap:8px; cursor:pointer}
    .switch input{accent-color:var(--blue);}
    .modal-footer{margin-top:12px; display:flex; gap:8px; justify-content:flex-end}

    .qr-wrap{display:grid; grid-template-columns:1fr 280px; gap:12px}
    @media (max-width:720px){.qr-wrap{grid-template-columns:1fr}}
    textarea{width:100%; min-height:80px; resize:vertical; background:#0a1325; border:1px solid var(--border); color:var(--text); border-radius:10px; padding:.6rem}

    .hint{color:var(--muted); font-size:.9rem}
    .sep{display:inline-flex; gap:8px; align-items:center}

    .pill{display:inline-flex; align-items:center; gap:6px; padding:.18rem .5rem; border:1px solid var(--border); border-radius:999px; font-size:.8rem; color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="container toolbar">
      <div class="title">
        <span><h2>ü§º Compteur de Lutte</h2></span>
      </div>
      <!-- Ic√¥nes seules √† droite -->
      <button class="btn icon-btn btn-outline" id="undoBtn" title="Annuler (Ctrl+Z)" aria-label="Annuler"><i class="bi bi-arrow-counterclockwise"></i></button>
      <button class="btn icon-btn btn-outline" id="redoBtn" title="R√©tablir (Ctrl+Y)" aria-label="R√©tablir"><i class="bi bi-arrow-clockwise"></i></button>
      <button class="btn icon-btn" id="resetBtn" title="R√©initialiser" aria-label="R√©initialiser"><i class="bi bi-arrow-repeat"></i></button>
      <button class="btn icon-btn" id="settingsBtn" title="Param√®tres" aria-label="Param√®tres"><i class="bi bi-gear"></i></button>
      <button class="btn icon-btn" id="statsBtn" title="Statistiques" aria-label="Statistiques"><i class="bi bi-graph-up"></i></button>
      <button class="btn icon-btn" id="exportBtn" title="Export QR" aria-label="Export QR"><i class="bi bi-qr-code"></i></button>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <!-- Colonne BLEU -->
      <section class="card blue" id="col-blue">
        <div class="card-h">
          <div class="col-title">
            <div class="pill" style="border-color:#234a9a">BLEU</div>
            <div class="badge"><span id="blueVolume">0</span>&nbsp;actions</div>
          </div>
          <div class="score"><span id="blueScore">0</span> <small>pts</small></div>
        </div>
        <div class="card-b" id="blueActions"></div>
      </section>

      <!-- Colonne ROUGE -->
      <section class="card red" id="col-red">
        <div class="card-h">
          <div class="col-title">
            <div class="pill" style="border-color:#7a1c1c">ROUGE</div>
            <div class="badge"><span id="redVolume">0</span>&nbsp;actions</div>
          </div>
          <div class="score"><span id="redScore">0</span> <small>pts</small></div>
        </div>
        <div class="card-b" id="redActions"></div>
      </section>
    </div>
  </main>

  <!-- Modal Param√®tres -->
  <div class="overlay" id="settingsModal" aria-hidden="true">
    <div class="backdrop" data-close></div>
    <div class="modal">
      <h3>Param√®tres</h3>
      <p class="hint">Ajustez les coefficients (0 √† 5) et activez/d√©sactivez les actions pour chaque lutteur.</p>
      <div class="grid2">
        <div class="section">
          <h4 style="margin:0 0 8px">Lutteur BLEU</h4>
          <div id="settingsBlue"></div>
        </div>
        <div class="section">
          <h4 style="margin:0 0 8px">Lutteur ROUGE</h4>
          <div id="settingsRed"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" data-close>Fermer</button>
      </div>
    </div>
  </div>

  <!-- Modal Export QR -->
  <div class="overlay" id="exportModal" aria-hidden="true">
    <div class="backdrop" data-close></div>
    <div class="modal">
      <h3>Export QR</h3>
      <div class="grid2">
        <div class="section">
          <label class="hint">Nom de l'arbitre</label>
          <input class="input" id="refereeInput" placeholder="Arbitre" />
          <div style="height:8px"></div>
          <label class="hint">Nom du lutteur BLEU</label>
          <input class="input" id="blueNameInput" placeholder="Lutteur bleu" />
          <div style="height:8px"></div>
          <label class="hint">Nom du lutteur ROUGE</label>
          <input class="input" id="redNameInput" placeholder="Lutteur rouge" />
          <div style="height:8px"></div>
          <div class="sep">
            <span class="hint">S√©parateur&nbsp;:</span>
            <label class="switch"><input type="radio" name="sep" value="," checked> virgule ","</label>
            <label class="switch"><input type="radio" name="sep" value=";"> point-virgule ";" (Excel/Numbers)</label>
          </div>
          <div style="height:10px"></div>
          <button class="btn" id="genQrBtn">G√©n√©rer le QR</button>
          <button class="btn btn-outline" id="copyLineBtn">Copier la ligne</button>
          <div style="height:10px"></div>
          <label class="hint">Ligne export√©e</label>
          <textarea id="qrText" readonly></textarea>
        </div>
        <div class="section" style="display:grid; place-items:center">
          <canvas id="qrCanvas" width="256" height="256" style="image-rendering:pixelated; border:1px solid var(--border); border-radius:12px"></canvas>
          <a id="dlPng" class="btn" download="lutte-qr.png" style="margin-top:10px">T√©l√©charger le PNG</a>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" data-close>Fermer</button>
      </div>
    </div>
  </div>

  <!-- Modal Statistiques -->
  <div class="overlay" id="statsModal" aria-hidden="true">
    <div class="backdrop" data-close></div>
    <div class="modal">
      <h3>Statistiques ‚Äì Volumes d'actions</h3>
      <p class="hint">Nombre d'actions par type (sans coefficients). Lignes : BLEU et ROUGE.</p>
      <div class="section">
        <canvas id="statsChart" height="220"></canvas>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" data-close>Fermer</button>
      </div>
    </div>
  </div>
 <p style="color: grey ; text-align:center ; font-size: 12px"> Copyright &copy; 2022-<script>document.write(new Date().getFullYear())</script> Webj√©j√© - Licence Creative Commons</p>
  <script>
    // --- Mod√®le de donn√©es ---
    const ACTIONS = ["saisie","chute","passage dos","mise en danger","tomb√©"]; // ordre fixe
    const DEFAULT_COEFFS = [1,2,3,4,5];

    const LS_KEY = "lutte_app_v1";

    const state = {
      blue: { counts:[0,0,0,0,0], coeffs:[...DEFAULT_COEFFS], active:[true,true,true,true,true], name:"BLEU" },
      red:  { counts:[0,0,0,0,0], coeffs:[...DEFAULT_COEFFS], active:[true,true,true,true,true], name:"ROUGE" },
      referee: "",
      history: [], // pile d'actions {side:"blue|red", i:index}
      future: []   // pile pour redo
    };

    // --- Utilitaires ---
    const el = sel => document.querySelector(sel);
    const els = sel => Array.from(document.querySelectorAll(sel));

    function save(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }
    function load(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      try{
        const s = JSON.parse(raw);
        ["blue","red"].forEach(side=>{
          if(s[side]){
            state[side].counts = s[side].counts?.slice(0,5) ?? [0,0,0,0,0];
            state[side].coeffs = s[side].coeffs?.slice(0,5) ?? [...DEFAULT_COEFFS];
            state[side].active = s[side].active?.slice(0,5) ?? [true,true,true,true,true];
            state[side].name   = s[side].name || state[side].name;
          }
        });
        state.referee = s.referee || "";
      }catch(e){ console.warn("Erreur de chargement:", e); }
    }

    function totalPoints(side){
      return state[side].counts.reduce((sum,c,i)=> sum + c*state[side].coeffs[i], 0);
    }
    function totalVolume(side){
      return state[side].counts.reduce((sum,c)=> sum + c, 0);
    }

    // --- Rendu UI ---
    function renderColumn(side){
      const wrapper = el('#'+side+'Actions');
      wrapper.innerHTML = '';
      ACTIONS.forEach((label,i)=>{
        const btnWrap = document.createElement('div');
        btnWrap.className = 'action';
        const btn = document.createElement('button');
        btn.textContent = label;
        btn.dataset.index = i;
        btn.dataset.side = side;
        if(!state[side].active[i]) btn.disabled = true;
        btn.addEventListener('click', onActionClick);
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.textContent = 'coef ' + state[side].coeffs[i];
        const count = document.createElement('span');
        count.className = 'count';
        count.textContent = '√ó ' + state[side].counts[i];
        btnWrap.appendChild(btn); btnWrap.appendChild(chip); btnWrap.appendChild(count);
        wrapper.appendChild(btnWrap);
      });

      el('#'+(side==='blue'?'blueScore':'redScore')).textContent = totalPoints(side);
      el('#'+(side==='blue'?'blueVolume':'redVolume')).textContent = totalVolume(side);
    }

    function renderSettings(){
      const mkRows = (side)=>{
        const wrap = document.createElement('div');
        ACTIONS.forEach((label,i)=>{
          const row = document.createElement('div');
          row.className = 'row';
          const name = document.createElement('div');
          name.textContent = label;
          const sel = document.createElement('select');
          sel.className='select';
          for(let v=0; v<=5; v++){
            const opt = document.createElement('option');
            opt.value=v; opt.textContent=v;
            if(v===state[side].coeffs[i]) opt.selected=true;
            sel.appendChild(opt);
          }
          sel.addEventListener('change',()=>{
            state[side].coeffs[i] = +sel.value; save(); renderAll();
          });

          const sw = document.createElement('label');
          sw.className='switch';
          const cb = document.createElement('input');
          cb.type='checkbox'; cb.checked = !!state[side].active[i];
          cb.addEventListener('change',()=>{
            state[side].active[i] = cb.checked; save(); renderAll();
          });
          sw.appendChild(cb); sw.appendChild(document.createTextNode(' actif'));

          row.appendChild(name); row.appendChild(sel); row.appendChild(sw);
          wrap.appendChild(row);
        });
        return wrap;
      };
      const b = el('#settingsBlue'); b.innerHTML=''; b.appendChild(mkRows('blue'));
      const r = el('#settingsRed');  r.innerHTML=''; r.appendChild(mkRows('red'));
    }

    function renderAll(){
      renderColumn('blue');
      renderColumn('red');
    }

    // --- Actions ---
    function onActionClick(e){
      const i = +e.currentTarget.dataset.index;
      const side = e.currentTarget.dataset.side;
      state.history.push({side,i});
      state.future.length = 0; // purge redo
      state[side].counts[i]++;
      save(); renderAll();
    }

    function undo(){
      const last = state.history.pop();
      if(!last) return;
      const {side,i} = last;
      if(state[side].counts[i] > 0) state[side].counts[i]--;
      state.future.push(last);
      save(); renderAll();
    }
    function redo(){
      const next = state.future.pop();
      if(!next) return;
      const {side,i} = next;
      state[side].counts[i]++;
      state.history.push(next);
      save(); renderAll();
    }
    function resetCounts(){
      state.blue.counts = [0,0,0,0,0];
      state.red.counts  = [0,0,0,0,0];
      state.history.length = 0; state.future.length = 0;
      save(); renderAll();
    }

    // --- Modals g√©n√©riques ---
    function openModal(id){ el('#'+id).classList.add('open'); }
    function closeModals(){ els('.overlay').forEach(m=>m.classList.remove('open')); }
    els('.overlay').forEach(m=>{
      m.addEventListener('click', (e)=>{ if(e.target.hasAttribute('data-close')) closeModals(); });
      m.querySelectorAll('[data-close]').forEach(b=> b.addEventListener('click', closeModals));
    });

    // --- Export QR ---
    let qr;
    function buildExportLine(sep){
      const fields = [];
      const ref = (el('#refereeInput').value||'').trim();
      const nb  = (el('#blueNameInput').value||'').trim() || 'BLEU';
      const nr  = (el('#redNameInput').value||'').trim() || 'ROUGE';
      // arbitre, bleu, rouge, total_bleu, volume_bleu, total_rouge, volume_rouge, 5 volumes BLEU, 5 volumes ROUGE
      fields.push(ref, nb, nr);
      fields.push(String(totalPoints('blue')));
      fields.push(String(totalVolume('blue')));
      fields.push(String(totalPoints('red')));
      fields.push(String(totalVolume('red')));
      state.blue.counts.forEach(v=>fields.push(String(v)));
      state.red.counts.forEach(v=>fields.push(String(v)));
      return fields.join(sep);
    }
    function updateQr(){
      const sep = (document.querySelector('input[name="sep"]:checked')?.value) || ',';
      const line = buildExportLine(sep);
      el('#qrText').value = line;
      if(!qr){ qr = new QRious({ element: el('#qrCanvas'), size:256, value: line }); }
      else { qr.value = line; }
      el('#dlPng').href = el('#qrCanvas').toDataURL('image/png');
      // Persist noms
      state.referee = el('#refereeInput').value;
      state.blue.name = el('#blueNameInput').value || 'BLEU';
      state.red.name  = el('#redNameInput').value  || 'ROUGE';
      save();
    }

    // --- Statistiques (Chart.js) ---
    let chart;
    function openStats(){
      const ctx = el('#statsChart');
      const dataBlue = [...state.blue.counts];
      const dataRed  = [...state.red.counts];
      if(!chart){
        chart = new Chart(ctx, {
          type:'line',
          data:{
            labels: ACTIONS.map(a=>a.toUpperCase()),
            datasets:[
              {label:'BLEU', data:dataBlue, tension:.25, borderWidth:2, borderColor:'#3b82f6'},
              {label:'ROUGE', data:dataRed, tension:.25, borderWidth:2, borderColor:'#ef4444'}
            ]
          },
          options:{
            responsive:true,
            plugins:{legend:{labels:{color:'#d1d5db'}}},
            scales:{
              x:{ticks:{color:'#9ca3af'}, grid:{color:'#1f2a44'}},
              y:{ticks:{color:'#9ca3af'}, grid:{color:'#1f2a44'}, beginAtZero:true, precision:0}
            }
          }
        });
      }else{
        chart.data.datasets[0].data = dataBlue;
        chart.data.datasets[1].data = dataRed;
        chart.update();
      }
      openModal('statsModal');
    }

    // --- Raccourcis clavier ---
    document.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='z'){ e.preventDefault(); undo(); }
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='y'){ e.preventDefault(); redo(); }
      if(e.key==='Escape') closeModals();
    });

    // --- Initialisation ---
    function init(){
      load();
      // Construire colonnes
      renderAll();

      // Boutons header
      el('#undoBtn').addEventListener('click', undo);
      el('#redoBtn').addEventListener('click', redo);
      el('#resetBtn').addEventListener('click', ()=>{ if(confirm('R√©initialiser tous les compteurs ?')) resetCounts(); });

      el('#settingsBtn').addEventListener('click', ()=>{ renderSettings(); openModal('settingsModal'); });
      el('#exportBtn').addEventListener('click', ()=>{
        // Pr√©-remplir noms
        el('#refereeInput').value = state.referee || '';
        el('#blueNameInput').value = state.blue.name==='BLEU'?'':state.blue.name;
        el('#redNameInput').value  = state.red.name==='ROUGE'?'':state.red.name;
        updateQr();
        openModal('exportModal');
      });
      el('#statsBtn').addEventListener('click', openStats);

      // Export QR events
      el('#genQrBtn').addEventListener('click', updateQr);
      els('input[name="sep"]').forEach(r=> r.addEventListener('change', updateQr));
      el('#copyLineBtn').addEventListener('click', ()=>{
        const t = el('#qrText'); t.select(); t.setSelectionRange(0, 99999);
        document.execCommand('copy');
      });
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      // G√©n√©rer les conteneurs d'actions
      function buildSide(side){
        const container = document.getElementById(side+'Actions');
        container.innerHTML='';
        ACTIONS.forEach((_,i)=>{
          const d = document.createElement('div'); d.className='action';
          const b = document.createElement('button'); b.dataset.side=side; b.dataset.index=i; b.addEventListener('click', onActionClick);
          const c = document.createElement('span'); c.className='chip';
          const k = document.createElement('span'); k.className='count';
          d.appendChild(b); d.appendChild(c); d.appendChild(k); container.appendChild(d);
        });
      }
      buildSide('blue'); buildSide('red');
      init();
    });
  </script>
</body>
</html>
